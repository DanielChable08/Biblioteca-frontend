<div class="full-container">

  <div class="main-header">
    <div class="header-brand">
      <i class="pi pi-home brand-logo"></i>
      <div class="brand-info">
        <span class="brand-title">Biblioteca Física</span>
        <span class="admin-badge">Administrador</span>
        <div class="brand-subtitle">Panel de administración del catálogo físico</div>
      </div>
    </div>
    <div class="header-user-section">
      <div class="user-text">
        <span class="user-role">Bibliotecario(a)</span>
        <span class="user-name">Bibliotecario</span>
      </div>
      <div class="user-avatar">B</div>
    </div>
  </div>


  <div class="search-section">
    <div class="search-container">
      <i class="pi pi-search search-icon"></i>
      <input type="text" pInputText placeholder="Buscar libros, autores, temas..." class="main-search-input" [(ngModel)]="terminoBusqueda" />
    </div>

    <div class="custom-filter-dropdown-container" (click)="toggleDropdown()">
      <div class="custom-filter-dropdown-trigger">
        <i class="pi pi-filter"></i>
        <span>{{ getDropdownText() }}</span>
        <i class="pi pi-chevron-down" [class.rotated]="dropdownOpen"></i>
      </div>
      <div class="custom-filter-dropdown-panel" *ngIf="dropdownOpen">
        <div *ngFor="let categoria of categorias"
             class="filter-dropdown-option"
             [class.selected]="esCategoriaActiva(categoria)"
             (click)="selectCategoria(categoria); $event.stopPropagation()">
          <i class="pi pi-book"></i>
          <span>{{ categoria.nombre === 'Todas' ? 'Todas las categorías' : categoria.nombre }}</span>
          <b>({{ contadorCategorias[categoria.nombre] }})</b>
        </div>
      </div>
    </div>
    <button pButton label="Crear Libro" icon="pi pi-plus" (click)="agregarLibro()"></button>
  </div>


  <div class="info-stats-row">
    <span class="main-stat">{{ libros.length }} libros en catálogo</span>
    <span class="secondary-stat">Última actualización: Hoy</span>
    <span class="secondary-stat">Nuevos ingresos: 3 libros esta semana</span>
  </div>


  <div class="categories-wrapper">
    <h3 class="categories-title">Categorías</h3>
    <div class="categories-buttons-row">
      <button pButton
              *ngFor="let categoria of categorias"
              [class]="'category-button ' + (esCategoriaActiva(categoria) ? 'active-category' : '')"
              (click)="filtrarCategoria(categoria)">
        <i class="pi pi-book"></i>
        <span>{{ categoria.nombre }}</span>
        <b>{{ contadorCategorias[categoria.nombre] }}</b>
      </button>
    </div>
  </div>

  <div class="catalog-title">
    {{ categoriaSeleccionada === 'Todas' ? 'Catálogo Completo' : 'Categoría: ' + categoriaSeleccionada.nombre }}
    ({{ librosFiltrados.length }} libro{{ librosFiltrados.length !== 1 ? 's' : '' }})
  </div>

  <div class="catalog-grid">
    <p-card *ngFor="let libro of librosFiltrados" class="book-card-compact">
      <ng-template pTemplate="header">
        <div class="book-image-container">
          <img [src]="libro.imagen" alt="portada" class="book-img-compact" />
          <span class="status-badge"
                [ngClass]="libro.estado === 'Disponible' ? 'available' : libro.estado === 'Prestado' ? 'borrowed' : 'repair'">
            {{ libro.estado }}
          </span>
        </div>
      </ng-template>

      <div class="book-info-compact">
        <h4 class="book-title-compact">{{ libro.titulo }}</h4>
        <p class="book-author-compact">{{ libro.autores && libro.autores.length > 0 ? (libro.autores[0].nombre + ' ' + libro.autores[0].apPaterno) : 'Autor Desconocido' }}</p>
        <span class="book-category-compact">{{ libro.categoria?.nombre }}</span>

        <div class="book-details-compact">
          <span class="detail-item-compact"><i class="pi pi-tag"></i> {{ libro.isbn }}</span>
          <span class="detail-item-compact"><i class="pi pi-map-marker"></i> {{ libro.ubicacion }}</span>
          <span class="detail-item-compact"><i class="pi pi-calendar"></i> {{ libro.anho }}</span>
          <span class="detail-item-compact"><i class="pi pi-file"></i> {{ libro.paginas }} páginas</span>
        </div>
      </div>

      <div class="book-actions-compact">
        <button pButton icon="pi pi-eye" class="action-btn-compact view-btn" pTooltip="Ver" (click)="verLibro(libro.uuid)"></button>
        <button pButton icon="pi pi-pencil" class="action-btn-compact edit-btn" pTooltip="Editar" (click)="editarLibro(libro.uuid)"></button>
        <button pButton icon="pi pi-trash" class="action-btn-compact delete-btn" pTooltip="Eliminar" (click)="eliminarLibro(libro.uuid)"></button>
      </div>
    </p-card>
  </div>

  <div *ngIf="librosFiltrados.length === 0" class="no-books-message">
    <i class="pi pi-info-circle"></i>
    <h3>No hay libros en esta categoría</h3>
    <p>La categoría "{{ categoriaSeleccionada === 'Todas' ? 'Todas' : categoriaSeleccionada.nombre }}" no contiene libros actualmente.</p>
  </div>
</div>

<app-book-details-modal
  [(display)]="displayModal"
  [libro]="selectedLibro">
</app-book-details-modal>

<p-confirmDialog></p-confirmDialog>
